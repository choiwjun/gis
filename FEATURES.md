# GIS Web App - 機能一覧

最終更新: 2025-12-01

## ✅ 実装済み機能

### 🔐 認証・ユーザー管理

#### 認証
- **JWT ベースのログイン** - セキュアな認証システム
- **トークンベースの API 認証** - Bearer Token 方式
- **ログイン状態の永続化** - LocalStorage 使用

#### ユーザー管理
- **ユーザー登録** (`POST /api/users/register`)
  - メールアドレス
  - パスワード (SHA-256 ハッシュ)
  - 名前
  - デフォルトロール: viewer

- **プロフィール編集** (`PUT /api/users/:id`)
  - 名前変更
  - パスワード変更
  - ロール変更 (admin のみ)

- **ユーザー設定** (`PUT /api/users/:id/preferences`)
  - カスタム設定の保存
  - JSON 形式

- **ユーザー一覧** (`GET /api/users`) - admin のみ
  - ページネーション対応
  - ロールフィルタ

### 📦 データセット管理

- **アップロード機能**
  - GeoJSON (.geojson, .json)
  - CSV (.csv)
  - Shapefile (.zip)
  - R2 ストレージへ自動保存

- **データセット一覧** (`GET /api/datasets`)
  - ページネーション
  - タイプフィルタ
  - ステータス管理

- **データセット詳細** (`GET /api/datasets/:id`)
  - メタデータ
  - スキーマ情報
  - レコード数

- **削除機能** (`DELETE /api/datasets/:id`) - admin のみ
  - R2 ファイル削除
  - 関連フィーチャー削除 (CASCADE)

### ✏️ データ編集

#### フィーチャー作成 (`POST /api/features`)
- **描画モード**
  - 地図上でクリックして作成
  - 属性情報入力ダイアログ
  - リアルタイムプレビュー

- **属性設定**
  - name, category, score など
  - カスタム属性対応

#### フィーチャー更新 (`PUT /api/features/:id`)
- ジオメトリ変更
- 属性変更
- 部分更新対応

#### フィーチャー削除 (`DELETE /api/features/:id`)
- 確認ダイアログ
- データセットレコード数自動更新

### 🗺️ 地図表示

#### 基本機能
- **MapLibre GL JS 統合**
- **OpenStreetMap ベースマップ**
- **ナビゲーションコントロール**
- **スケールコントロール**

#### レイヤー管理
- **表示/非表示切替**
- **複数レイヤー対応**
- **レイヤー順序管理**

#### クラスタリング
- **自動グループ化**
  - 1-9件: 明るいブルー (14px)
  - 10-49件: 標準ブルー (18px)
  - 50件以上: 濃いブルー (22px)

- **ズーム依存**
  - クラスタ半径自動調整
  - クラスタクリックでズームイン

#### インタラクション
- **ポイントクリック** - 詳細パネル表示
- **ホバー** - カーソル変更
- **BBOX フィット** - 自動範囲調整

### 🔍 検索・フィルタリング

#### 基本検索 (`GET /api/search`)
- **キーワード検索**
  - LIKE クエリ
  - 部分一致

- **属性フィルタ**
  - category フィルタ
  - score 範囲指定 (min/max)

#### 全文検索 (`GET /api/search?fts=true`)
- **SQLite FTS5**
  - features_fts 仮想テーブル
  - 高速全文検索
  - 自動インデックス更新 (トリガー)

#### 高度な検索 (`GET /api/search/advanced`)
- **複数条件フィルタ**
  - 等価 (eq)
  - 大小比較 (gt, lt)
  - LIKE 検索
  - IN 検索 (配列)

- **JSON 形式フィルタ**
  ```json
  {
    "category": {"operator": "eq", "value": "type1"},
    "score": {"operator": "gt", "value": 80}
  }
  ```

#### 空間検索
- **BBOX 検索** - 地図範囲内
- **近傍検索** (`GET /api/map/nearby`)
  - 指定座標から半径検索
  - Haversine 距離計算

### 🎨 スタイル管理

#### レイヤースタイル (`/api/styles`)
- **スタイル作成**
  - 色、透明度、線幅など
  - JSON 形式で保存

- **デフォルトスタイル**
  - データセットごとに設定
  - 自動適用

- **スタイル一覧**
  - データセットでフィルタ
  - デフォルトスタイル優先表示

- **スタイル更新・削除**
  - 動的スタイル変更
  - 複数スタイル保存

### 📤 データエクスポート

#### GeoJSON エクスポート (`GET /api/export/geojson`)
- **フォーマット**: application/geo+json
- **ダウンロード**: {dataset_name}.geojson
- **内容**: 全フィーチャー + プロパティ

#### CSV エクスポート (`GET /api/export/csv`)
- **フォーマット**: text/csv
- **ダウンロード**: {dataset_name}.csv
- **カラム**: id, longitude, latitude, geometry_type, properties
- **自動エスケープ**: カンマ、引用符対応

#### 統計情報 (`GET /api/export/summary`)
- **データセット情報**
  - 名前、タイプ、レコード数
  - 作成者、作成日

- **統計データ**
  - ジオメトリタイプ別件数
  - Bounding Box (min/max lon/lat)

### 📸 高度な機能

#### 地図スクリーンショット
- **PNG エクスポート**
- **Canvas API 使用**
- **ファイル名**: map_YYYY-MM-DD.png

#### アクティビティログ
- **操作記録**
  - create, update, delete
  - resource_type, resource_id
  - details (JSON)

- **用途**
  - 監査ログ
  - 使用状況分析

#### ユーザー設定
- **永続化**
  - user_preferences テーブル
  - JSON 形式

- **カスタマイズ可能**
  - デフォルトズームレベル
  - お気に入りレイヤー
  - 表示設定

### 🖥️ UI/UX

#### レイアウト
- **3カラム構成**
  - 左: 検索・レイヤーパネル (320px)
  - 中央: 地図表示
  - 右: 詳細パネル (384px, スライドイン)

#### コンポーネント
- **ヘッダー**
  - ロゴ、ユーザー情報
  - ログアウトボタン

- **検索パネル**
  - キーワード入力
  - 検索ボタン

- **レイヤーパネル**
  - データセット一覧
  - チェックボックス切替
  - リフレッシュボタン

- **高度なツールパネル**
  - 高度な検索
  - 描画モード
  - エクスポート
  - スクリーンショット

- **詳細パネル**
  - フィーチャーID
  - プロパティ一覧 (Key-Value)
  - 編集・削除ボタン (admin/editor)

#### スタイリング
- **Tailwind CSS**
- **カラーパレット**
  - Primary: #1E6EFF
  - Primary Soft: #E5F0FF
  - Success: #16A34A
  - Danger: #EF4444

- **アイコン**
  - Font Awesome 6.4.0
  - 直感的なアイコン選択

## ⏳ 未実装機能

### 高度な可視化
- ヒートマップレイヤー
- 3D 地形表示
- アニメーション

### ジオメトリ編集
- ライン・ポリゴン描画
- 頂点編集
- スナップ機能

### データ連携
- WMS/WFS 連携
- PostGIS 直接接続
- リアルタイムデータ

### 多言語対応
- 日本語/韓国語/英語切替
- i18n ライブラリ統合

## 🔧 技術仕様

### データベース
- **SQLite (Cloudflare D1)**
- **FTS5** - 全文検索エンジン
- **トリガー** - 自動インデックス更新

### ストレージ
- **Cloudflare R2** - S3互換
- **オブジェクトストレージ** - GeoJSONファイル

### セキュリティ
- **JWT** - HS256署名
- **SHA-256** - パスワードハッシュ
- **CORS** - API保護

### パフォーマンス
- **クラスタリング** - 大量データ対応
- **ページネーション** - リスト表示
- **BBOX検索** - 効率的な範囲検索
- **FTS** - 高速全文検索

---

**作成者**: ナリモト株式会社  
**バージョン**: 2.0.0  
**ライセンス**: MIT
